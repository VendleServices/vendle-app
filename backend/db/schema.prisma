generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  email               String                @unique
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @default(now()) @updatedAt
  companyName         String?
  companyWebsite      String?
  phoneNumber         String?
  userType            String?
  ndaSigned           Boolean?              @default(false)
  id                  String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  bids                Bid[]
  claims              Claim[]
  winningClaims       Claim[]               @relation("WinningContractor")
  claimInvitations    ClaimInvitation[]
  claimParticipants   ClaimParticipant[]
  documents           DocumentChunk[]
  femaForms           Fema[]
  projects            Project[]
  document_embeddings document_embeddings[]
  chats               Chat[]
  messages            Message[]
  rooms               Room[]
  roomReadStatuses    RoomReadStatus[]
}

model Fema {
  firstName          String
  lastName           String
  email              String
  phone              String
  address            String
  city               String
  state              String
  zipCode            String
  propertyDamage     String
  isPrimaryResidence Boolean
  hasInsurance       Boolean
  isUsCitizen        Boolean
  createdAt          DateTime @default(now())
  updatedAt          DateTime @default(now()) @updatedAt
  id                 String   @id @default(uuid()) @db.Uuid
  userId             String   @db.Uuid
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Claim {
  street                 String
  city                   String
  state                  String
  zipCode                String
  projectType            String
  designPlan             String
  needsAdjuster          Boolean
  createdAt              DateTime              @default(now())
  updatedAt              DateTime              @default(now()) @updatedAt
  damageTypes            String
  hasDumpster            Boolean
  hasFunctionalUtilities Boolean
  isOccupied             Boolean
  phase1End              String
  phase1Start            String
  phase2End              String
  phase2Start            String
  additionalNotes        String
  aiSummary              String?
  costBasis              String
  depreciation           Float
  fundingSource          String
  hasDeductibleFunds     Boolean               @default(false)
  materials              Float
  overheadAndProfit      Float
  reconstructionType     String
  salesTaxes             Float
  totalJobValue          Float
  title                  String
  status                 ClaimStatus           @default(PENDING)
  id                     String                @id @default(uuid()) @db.Uuid
  userId                 String                @db.Uuid
  winnerId               String?               @db.Uuid
  auctionPhases          AuctionPhase[]
  bids                   Bid[]
  user                   User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  winner                 User?                 @relation("WinningContractor", fields: [winnerId], references: [id])
  claimInvitations       ClaimInvitation[]
  claimParticipants      ClaimParticipant[]
  pdfs                   ClaimPdf[]
  documents              DocumentChunk[]
  images                 Image[]
  project                Project?              @relation("ClaimProject")
  document_embeddings    document_embeddings[]
  chats                  Chat[]
  payments               Payment[]
}

model Image {
  supabase_url String
  id           String @id @default(uuid()) @db.Uuid
  claimId      String @db.Uuid
  claim        Claim  @relation(fields: [claimId], references: [id], onDelete: Cascade)
}

model ClaimPdf {
  supabase_url String
  id           String @id @default(uuid()) @db.Uuid
  claimId      String @db.Uuid
  claim        Claim  @relation(fields: [claimId], references: [id], onDelete: Cascade)
}

model Bid {
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @default(now()) @updatedAt
  amount                Float
  allowance             Float
  bidPdfPath            String
  budgetTotal           Float
  laborCosts            Float
  overhead              Float
  profit                Float
  subContractorExpenses Float
  id                    String       @id @default(uuid()) @db.Uuid
  userId                String       @db.Uuid
  claimId               String       @db.Uuid
  auctionPhaseId        String       @db.Uuid
  auctionPhase          AuctionPhase @relation(fields: [auctionPhaseId], references: [id], onDelete: Cascade)
  claim                 Claim        @relation(fields: [claimId], references: [id], onDelete: Cascade)
  user                  User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  payments              Payment[]
}

model ClaimParticipant {
  status         ParticipationStatus @default(PENDING)
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @default(now()) @updatedAt
  id             String              @id @default(uuid()) @db.Uuid
  claimId        String              @db.Uuid
  userId         String              @db.Uuid
  invitedBy      String?             @db.Uuid
  auctionPhaseId String?             @db.Uuid
  auctionPhase   AuctionPhase?       @relation(fields: [auctionPhaseId], references: [id])
  claim          Claim               @relation(fields: [claimId], references: [id], onDelete: Cascade)
  user           User                @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model AuctionPhase {
  number       Int
  startDate    String
  endDate      String
  status       PhaseStatus        @default(NOT_STARTED)
  id           String             @id @default(uuid()) @db.Uuid
  claimId      String             @db.Uuid
  claim        Claim              @relation(fields: [claimId], references: [id], onDelete: Cascade)
  bids         Bid[]
  participants ClaimParticipant[]
}

model ClaimInvitation {
  status       InvitationStatus @default(PENDING)
  createdAt    DateTime         @default(now())
  id           String           @id @default(uuid()) @db.Uuid
  claimId      String           @db.Uuid
  contractorId String           @db.Uuid
  invitedBy    String?          @db.Uuid
  claim        Claim            @relation(fields: [claimId], references: [id], onDelete: Cascade)
  contractor   User             @relation(fields: [contractorId], references: [id], onDelete: Cascade)
}

model Project {
  status       ProjectStatus      @default(DRAFT)
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @default(now()) @updatedAt
  id           String             @id @default(uuid()) @db.Uuid
  contractorId String             @db.Uuid
  claimId      String             @unique @db.Uuid
  claim        Claim              @relation("ClaimProject", fields: [claimId], references: [id])
  contractor   User               @relation(fields: [contractorId], references: [id])
  milestones   PaymentMilestone[]
}

model PaymentMilestone {
  id              String                 @id @default(uuid()) @db.Uuid
  projectId       String                 @db.Uuid
  stage           MilestoneStage
  percentage      Float
  amount          Float
  status          PaymentMilestoneStatus @default(PENDING)
  stripeSessionId String?                @unique
  paidAt          DateTime?
  createdAt       DateTime               @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, stage])
  @@index([projectId])
}

model DocumentChunk {
  id                  String                @id @default(uuid()) @db.Uuid
  documentName        String
  chunkIndex          Int
  content             String
  metadata            Json?
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @default(now()) @updatedAt
  userId              String                @db.Uuid
  claimId             String                @db.Uuid
  claim               Claim                 @relation(fields: [claimId], references: [id])
  user                User                  @relation(fields: [userId], references: [id])
  document_embeddings document_embeddings[]

  @@unique([claimId, documentName, chunkIndex])
  @@index([userId])
  @@index([claimId])
}

model document_embeddings {
  id                String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  document_chunk_id String                @db.Uuid
  user_id           String                @db.Uuid
  claim_id          String                @db.Uuid
  embedding         Unsupported("vector")
  created_at        DateTime              @default(now()) @db.Timestamptz(6)
  Claim             Claim                 @relation(fields: [claim_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_claim")
  DocumentChunk     DocumentChunk         @relation(fields: [document_chunk_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_document_chunk")
  User              User                  @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_user")

  @@index([claim_id], map: "idx_document_embeddings_claim")
  @@index([user_id], map: "idx_document_embeddings_user")
  @@index([embedding], map: "idx_document_embeddings_vector")
}

model Chat {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @db.Uuid
  claimId   String   @db.Uuid
  role      ChatRole
  content   String
  createdAt DateTime @default(now())

  claim Claim @relation(fields: [claimId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id])
}

model BookingAttempt {
  id           String        @id @default(uuid()) @db.Uuid
  bookingToken String        @unique
  contractorId String        @db.Uuid
  homeownerId  String        @db.Uuid
  status       BookingStatus @default(PENDING)
  createdAt    DateTime      @default(now())
}

model Meeting {
  id               String        @id @default(uuid()) @db.Uuid
  bookingToken     String        @unique
  contractorId     String        @db.Uuid
  homeownerId      String        @db.Uuid
  startTime        DateTime
  endTime          DateTime
  calendlyEventUri String        @unique
  inviteeEmail     String
  status           MeetingStatus @default(SCHEDULED)
  createdAt        DateTime      @default(now())
  canceledAt       DateTime?
}

model HomeownerAvailability {
  id          String @id @default(uuid()) @db.Uuid
  homeownerId String @db.Uuid
  dayOfWeek   Int
  startTime   String
  endTime     String
}

model Payment {
  id                    String        @id @default(uuid()) @db.Uuid
  bidId                 String        @db.Uuid
  claimId               String        @db.Uuid
  homeownerId           String        @db.Uuid
  contractorId          String        @db.Uuid
  amount                Float
  bidAmount             Float
  platformFee           Float
  stripeSessionId       String?       @unique
  stripePaymentIntentId String?
  status                PaymentStatus @default(PENDING)
  createdAt             DateTime      @default(now())
  completedAt           DateTime?

  bid   Bid   @relation(fields: [bidId], references: [id])
  claim Claim @relation(fields: [claimId], references: [id])

  @@index([bidId])
  @@index([claimId])
}

model Room {
  id               String           @id @default(cuid())
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  messages         Message[]
  users            User[]
  roomReadStatuses RoomReadStatus[]
}

model Message {
  id        String   @id @default(cuid())
  content   String   @db.Text
  createdAt DateTime @default(now())
  roomId    String
  room      Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)
  userId    String   @db.Uuid
  sender    User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([roomId])
  @@index([userId])
}

model RoomReadStatus {
  id         String   @id @default(cuid())
  userId     String   @db.Uuid
  roomId     String
  lastReadAt DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id])
  room       Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@unique([userId, roomId])
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  EXPIRED
  REFUNDED
}

enum ChatRole {
  USER
  SYSTEM
}

enum ProjectStatus {
  DRAFT
  AUCTION_OPEN
  AUCTION_CLOSED
  IOI
  LOI
  ACTIVE
  COMPLETED
  REVIEWED
}

enum NegotiationPhase {
  IOI
  LOI
}

enum NegotiationStatus {
  pending
  accepted
  declined
}

enum MilestoneStatus {
  pending
  submitted
  approved
  paid
}

enum ScheduleEventKind {
  site_visit
  ioi_deadline
  loi_deadline
  milestone_deadline
}

enum ParticipationStatus {
  PENDING
  NDA_SIGNED
  APPROVED
  ADVANCED
  REJECTED
}

enum ClaimStatus {
  PENDING
  ACTIVE
  CLOSED
}

enum PhaseStatus {
  NOT_STARTED
  ACTIVE
  CLOSED
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  DECLINED
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELED
}

enum MeetingStatus {
  SCHEDULED
  CANCELED
}

enum MilestoneStage {
  DOWN_PAYMENT
  STAGE_1
  STAGE_2
  FINAL_STAGE
  RETAINAGE
}

enum PaymentMilestoneStatus {
  PENDING
  CURRENT
  PAID
}
